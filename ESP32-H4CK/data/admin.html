<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - SecureNet Banking</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">SecureNet Banking</a>
        <button class="hamburger" onclick="document.querySelector('.navbar-nav').classList.toggle('open')">&#9776;</button>
        <ul class="navbar-nav">
            <li><a href="/">Home</a></li>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/transactions">Transactions</a></li>
            <li><a href="/transfer">Transfer</a></li>
            <li><a href="/shop">Shop</a></li>
            <li><a href="/cart">Cart</a></li>
            <li><a href="/orders">Orders</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/admin" class="active">Admin</a></li>
            <li><a href="/shell.html">Shell</a></li>
        </ul>
        <div class="navbar-user" id="navUser"></div>
    </nav>

    <div class="container">
        <!-- System Stats -->
        <div class="card">
            <h2>System Statistics</h2>
            <div class="stats" id="systemStats">
                <div class="empty-msg">Loading...</div>
            </div>
        </div>

        <!-- Wallet Stats -->
        <div class="card" id="walletStatsCard">
            <h2>Wallet Statistics</h2>
            <div class="stats" id="walletStats">
                <div class="empty-msg">Loading...</div>
            </div>
            <div style="margin-top:16px" id="walletAccounts"></div>
        </div>

        <!-- User Management -->
        <div class="card" id="userMgmtCard">
            <h2>User Management</h2>
            <div class="toolbar">
                <button class="btn" onclick="openCreateModal()">+ Create User</button>
                <button class="btn btn-outline" onclick="loadUsers()">Refresh</button>
                <button class="btn btn-outline" onclick="exportUsers()">Export CSV</button>
            </div>
            <div id="usersTable"><div class="empty-msg">Loading users...</div></div>
        </div>

        <!-- Wallet Management -->
        <div class="card" id="walletMgmtCard">
            <h2>Wallet Management</h2>
            <div class="toolbar">
                <button class="btn btn-danger" onclick="resetWallets()">Reset All Balances</button>
                <button class="btn btn-outline" onclick="loadWalletStats()">Refresh Stats</button>
            </div>
            <h3 style="color:var(--text);font-size:1em;margin:16px 0 8px">Adjust User Balance</h3>
            <div class="filter-bar">
                <input type="text" id="adjustUser" placeholder="Username" style="flex:1">
                <input type="number" id="adjustBalance" placeholder="New balance" step="0.01" style="width:140px">
                <button class="btn btn-sm" onclick="adjustBalance()">Set Balance</button>
            </div>
            <div id="adjustResult"></div>
        </div>

        <!-- Shop Management -->
        <div class="card" id="shopMgmtCard">
            <h2>Shop Management</h2>
            <div class="toolbar">
                <button class="btn" onclick="openAddProductModal()">+ Add Product</button>
                <button class="btn btn-outline" onclick="loadProducts()">Refresh Products</button>
                <button class="btn btn-outline" onclick="loadOrderStats()">Order Stats</button>
            </div>
            <h3 style="color:var(--text);font-size:1em;margin:16px 0 8px">Products</h3>
            <div id="productsTable"><div class="empty-msg">Loading products...</div></div>
            <h3 style="color:var(--text);font-size:1em;margin:24px 0 8px">Order Statistics</h3>
            <div id="orderStatsSection"><div class="empty-msg">Loading...</div></div>
            <h3 style="color:var(--text);font-size:1em;margin:24px 0 8px">Recent Orders</h3>
            <div id="recentOrdersTable"><div class="empty-msg">Loading orders...</div></div>
        </div>

        <!-- Active Sessions -->
        <div class="card" id="sessionsCard">
            <h2>Active Sessions</h2>
            <div id="sessionsTable"><div class="empty-msg">Loading sessions...</div></div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>Quick Actions</h2>
            <div class="actions-grid">
                <a href="/shell.html" class="btn">Open Shell</a>
                <a href="/api/info" class="btn btn-outline">System Info</a>
                <a href="/debug" class="btn btn-outline">Debug Info</a>
                <a href="/api/endpoints" class="btn btn-outline">Endpoints</a>
                <a href="/api/admin/logs" class="btn btn-outline">Access Logs</a>
                <a href="/api/admin/wallet/stats" class="btn btn-outline">Wallet Stats JSON</a>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <h3 id="modalTitle">Create User</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="modalUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="modalPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="modalRole">
                    <option value="guest">Guest</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn" id="modalSubmit" onclick="submitUserForm()">Create</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h3>Delete User</h3>
            <p style="color:#555;margin-bottom:16px;">Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        function getCookie(n){var m=document.cookie.match('(^|;)\\s*'+n+'=([^;]*)');return m?decodeURIComponent(m[2]):null}
        (function(){var ct=getCookie('auth_token'),cu=getCookie('auth_user'),cr=getCookie('auth_role');if(ct&&cu){localStorage.setItem('token',ct);localStorage.setItem('username',cu);localStorage.setItem('role',cr||'guest')}})();

        var token=localStorage.getItem('token'),currentUser=localStorage.getItem('username'),currentRole=localStorage.getItem('role');
        var editingUser=null,deletingUser=null;

        if(!token){window.location.href='/login';}

        // Check admin access
        if(currentRole!=='admin'){
            document.getElementById('userMgmtCard').style.display='none';
            document.getElementById('sessionsCard').style.display='none';
            document.getElementById('walletMgmtCard').style.display='none';
        }

        function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type+' show';setTimeout(function(){t.className='toast'},3000)}
        function authHeaders(){return{'Authorization':'Bearer '+token}}

        // System Stats
        async function loadSystemStats(){
            try{
                var r=await fetch('/api/info');var d=await r.json();
                document.getElementById('systemStats').innerHTML=
                    '<div class="stat-item"><h3>Uptime</h3><p>'+d.uptime+'s</p></div>'+
                    '<div class="stat-item"><h3>Free Heap</h3><p>'+(d.free_heap/1024).toFixed(1)+' KB</p></div>'+
                    '<div class="stat-item"><h3>Requests</h3><p>'+d.server.total_requests+'</p></div>'+
                    '<div class="stat-item"><h3>Sessions</h3><p>'+d.server.active_sessions+'</p></div>'+
                    '<div class="stat-item"><h3>IP</h3><p>'+d.wifi.ip+'</p></div>'+
                    '<div class="stat-item"><h3>WiFi</h3><p>'+d.wifi.rssi+' dBm</p></div>';
            }catch(e){document.getElementById('systemStats').innerHTML='<div class="empty-msg">Failed to load</div>';}
        }

        // Wallet Stats
        async function loadWalletStats(){
            try{
                var r=await fetch('/api/admin/wallet/stats',{headers:authHeaders()});
                var d=await r.json();
                document.getElementById('walletStats').innerHTML=
                    '<div class="stat-item"><h3>Total Balance</h3><p>'+d.total_balance.toFixed(0)+'</p></div>'+
                    '<div class="stat-item"><h3>Users</h3><p>'+d.user_count+'</p></div>'+
                    '<div class="stat-item"><h3>Avg Balance</h3><p>'+d.average_balance.toFixed(0)+'</p></div>'+
                    '<div class="stat-item"><h3>Richest</h3><p>'+d.richest_user+'</p></div>';

                // Accounts table
                if(d.accounts&&d.accounts.length>0){
                    var h='<table><thead><tr><th>User</th><th>Role</th><th>Balance</th></tr></thead><tbody>';
                    d.accounts.forEach(function(a){
                        var rc=a.role==='admin'?'admin':'guest';
                        h+='<tr><td><strong>'+a.username+'</strong></td>'+
                            '<td><span class="role-badge '+rc+'">'+a.role+'</span></td>'+
                            '<td>'+a.balance.toFixed(2)+' credits</td></tr>';
                    });
                    h+='</tbody></table>';
                    document.getElementById('walletAccounts').innerHTML=h;
                }
            }catch(e){document.getElementById('walletStats').innerHTML='<div class="empty-msg">Failed to load</div>';}
        }

        // Users
        async function loadUsers(){
            try{
                var r=await fetch('/api/users',{headers:authHeaders()});var d=await r.json();
                var div=document.getElementById('usersTable');
                if(d.users&&d.users.length>0){
                    var h='<table><thead><tr><th>Username</th><th>Role</th><th>Balance</th><th>Email</th><th>Actions</th></tr></thead><tbody>';
                    d.users.forEach(function(u){
                        var rc=u.role==='admin'?'admin':'guest';
                        var bal=u.balance!==undefined?u.balance.toFixed(2):'--';
                        h+='<tr><td><strong>'+u.username+'</strong></td>'+
                            '<td><span class="role-badge '+rc+'">'+u.role+'</span></td>'+
                            '<td>'+bal+' credits</td>'+
                            '<td style="font-size:.82em">'+(u.email||'--')+'</td>'+
                            '<td><button class="btn btn-sm btn-outline" onclick="openEditModal(\''+u.username+'\',\''+u.role+'\')">Edit</button> '+
                            '<button class="btn btn-sm btn-danger" onclick="openDeleteModal(\''+u.username+'\')">Delete</button></td></tr>';
                    });
                    h+='</tbody></table>';
                    div.innerHTML=h;
                }else{div.innerHTML='<div class="empty-msg">No users found.</div>';}
            }catch(e){document.getElementById('usersTable').innerHTML='<div class="empty-msg">Error loading users</div>';}
        }

        // Sessions
        async function loadSessions(){
            try{
                var r=await fetch('/api/admin/sessions');var d=await r.json();
                var div=document.getElementById('sessionsTable');
                if(d.sessions&&d.sessions.length>0){
                    var h='<table><thead><tr><th>User</th><th>Role</th><th>IP</th><th>Session ID</th></tr></thead><tbody>';
                    d.sessions.forEach(function(s){
                        var rc=s.role==='admin'?'admin':'guest';
                        h+='<tr><td><strong>'+s.username+'</strong></td>'+
                            '<td><span class="role-badge '+rc+'">'+s.role+'</span></td>'+
                            '<td>'+s.ip_address+'</td>'+
                            '<td style="font-family:monospace;font-size:.82em;color:#888">'+s.session_id.substring(0,16)+'...</td></tr>';
                    });
                    h+='</tbody></table>';
                    div.innerHTML=h;
                }else{div.innerHTML='<div class="empty-msg">No active sessions.</div>';}
            }catch(e){document.getElementById('sessionsTable').innerHTML='<div class="empty-msg">Error loading sessions</div>';}
        }

        // Create/Edit Modal
        function openCreateModal(){
            editingUser=null;
            document.getElementById('modalTitle').textContent='Create User';
            document.getElementById('modalSubmit').textContent='Create';
            document.getElementById('modalUsername').value='';
            document.getElementById('modalUsername').disabled=false;
            document.getElementById('modalPassword').value='';
            document.getElementById('modalRole').value='guest';
            document.getElementById('userModal').classList.add('open');
        }
        function openEditModal(username,role){
            editingUser=username;
            document.getElementById('modalTitle').textContent='Edit User: '+username;
            document.getElementById('modalSubmit').textContent='Save';
            document.getElementById('modalUsername').value=username;
            document.getElementById('modalUsername').disabled=true;
            document.getElementById('modalPassword').value='';
            document.getElementById('modalPassword').placeholder='Leave empty to keep current';
            document.getElementById('modalRole').value=role;
            document.getElementById('userModal').classList.add('open');
        }
        function closeModal(){document.getElementById('userModal').classList.remove('open')}

        async function submitUserForm(){
            var username=document.getElementById('modalUsername').value.trim();
            var password=document.getElementById('modalPassword').value;
            var role=document.getElementById('modalRole').value;
            if(!editingUser&&(!username||!password)){showToast('Username and password required','error');return}
            var fd=new FormData();
            fd.append('username',username);if(password)fd.append('password',password);fd.append('role',role);
            try{
                var r=await fetch('/api/users',{method:editingUser?'PUT':'POST',headers:authHeaders(),body:fd});
                var d=await r.json();
                if(d.success){showToast(editingUser?'User updated':'User created','success');closeModal();loadUsers();loadWalletStats();}
                else{showToast(d.error||'Failed','error');}
            }catch(e){showToast('Network error','error');}
        }

        function openDeleteModal(username){deletingUser=username;document.getElementById('deleteUsername').textContent=username;document.getElementById('deleteModal').classList.add('open')}
        function closeDeleteModal(){document.getElementById('deleteModal').classList.remove('open')}

        async function confirmDelete(){
            try{
                var r=await fetch('/api/users?username='+encodeURIComponent(deletingUser),{method:'DELETE',headers:authHeaders()});
                var d=await r.json();
                if(d.success){showToast('User deleted','success');loadUsers();loadWalletStats();}
                else{showToast(d.error||'Delete failed','error');}
            }catch(e){showToast('Network error','error');}
            closeDeleteModal();
        }

        function exportUsers(){window.open('/api/admin/users-export','_blank')}

        // Wallet Management
        async function resetWallets(){
            if(!confirm('Reset ALL user balances to defaults? This cannot be undone.'))return;
            try{
                var r=await fetch('/api/admin/wallet/reset',{method:'POST',headers:authHeaders()});
                var d=await r.json();
                if(d.success){showToast('All balances reset','success');loadWalletStats();loadUsers();}
                else{showToast(d.error||'Reset failed','error');}
            }catch(e){showToast('Error: '+e.message,'error');}
        }

        async function adjustBalance(){
            var user=document.getElementById('adjustUser').value.trim();
            var bal=document.getElementById('adjustBalance').value;
            if(!user||bal===''){showToast('Enter username and balance','error');return}
            try{
                var fd=new FormData();fd.append('username',user);fd.append('balance',bal);
                var r=await fetch('/api/admin/wallet/adjust',{method:'POST',headers:authHeaders(),body:fd});
                var d=await r.json();
                var div=document.getElementById('adjustResult');
                if(d.success){
                    div.innerHTML='<div class="message success" style="display:block;margin-top:8px">'+d.username+': '+d.old_balance.toFixed(2)+' -> '+d.new_balance.toFixed(2)+' credits</div>';
                    showToast('Balance adjusted','success');
                    loadWalletStats();loadUsers();
                }else{
                    div.innerHTML='<div class="message error" style="display:block;margin-top:8px">'+(d.error||'Failed')+'</div>';
                }
            }catch(e){showToast('Error: '+e.message,'error');}
        }

        // Shop Management
        async function loadProducts(){
            try{
                var r=await fetch('/api/shop/products');
                var d=await r.json();
                var html='<div class="table-responsive"><table style="width:100%"><thead><tr><th>ID</th><th>Name</th><th>Price</th><th>Inventory</th><th>Category</th><th>Actions</th></tr></thead><tbody>';
                if(d.products&&d.products.length>0){
                    d.products.forEach(p=>{
                        html+='<tr><td style="font-size:0.85em;font-family:monospace">'+p.id+'</td><td>'+p.name+'</td><td>'+p.price.toFixed(2)+' cr</td><td>'+p.inventory+'</td><td>'+p.category+'</td>';
                        html+='<td><button class="btn btn-sm btn-outline" onclick="editProduct(\''+p.id+'\')">Edit</button> ';
                        html+='<button class="btn btn-sm btn-danger" onclick="deleteProduct(\''+p.id+'\',\''+p.name+'\')">Delete</button></td></tr>';
                    });
                }else{html+='<tr><td colspan="6" class="empty-msg">No products found</td></tr>';}
                html+='</tbody></table></div>';
                document.getElementById('productsTable').innerHTML=html;
            }catch(e){document.getElementById('productsTable').innerHTML='<div class="empty-msg">Error loading products</div>';}
        }

        async function loadOrderStats(){
            try{
                var r=await fetch('/api/admin/shop/order-stats',{headers:authHeaders()});
                var d=await r.json();
                var html='<div class="stats"><div class="stat-item"><h3>Total Revenue</h3><p>'+d.total_revenue.toFixed(2)+' credits</p></div>';
                html+='<div class="stat-item"><h3>Total Orders</h3><p>'+d.order_count+'</p></div>';
                html+='<div class="stat-item"><h3>Completed</h3><p>'+d.completed_orders+'</p></div>';
                html+='<div class="stat-item"><h3>Pending</h3><p>'+d.pending_orders+'</p></div></div>';
                document.getElementById('orderStatsSection').innerHTML=html;
                loadAllOrders();
            }catch(e){document.getElementById('orderStatsSection').innerHTML='<div class="empty-msg">Error loading stats</div>';}
        }

        async function loadAllOrders(){
            try{
                var r=await fetch('/api/admin/shop/orders',{headers:authHeaders()});
                var d=await r.json();
                var html='<div class="table-responsive"><table style="width:100%"><thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Date</th></tr></thead><tbody>';
                if(d.orders&&d.orders.length>0){
                    d.orders.slice(0,10).forEach(o=>{
                        var date=new Date(o.timestamp).toLocaleDateString();
                        var items=o.items.length+' item(s)';
                        html+='<tr><td style="font-size:0.85em;font-family:monospace">'+o.order_id+'</td><td>'+o.username+'</td>';
                        html+='<td>'+items+'</td><td>'+o.total_amount.toFixed(2)+' cr</td><td><span class="status-badge status-'+o.status+'">'+o.status+'</span></td><td>'+date+'</td></tr>';
                    });
                }else{html+='<tr><td colspan="6" class="empty-msg">No orders found</td></tr>';}
                html+='</tbody></table></div>';
                document.getElementById('recentOrdersTable').innerHTML=html;
            }catch(e){document.getElementById('recentOrdersTable').innerHTML='<div class="empty-msg">Error loading orders</div>';}
        }

        function openAddProductModal(){
            var name=prompt('Product Name:');
            if(!name)return;
            var desc=prompt('Description:');
            var price=prompt('Price (credits):');
            var inv=prompt('Inventory:');
            var cat=prompt('Category (Hardware/Software):');
            if(!price||!inv)return;
            addProduct(name,desc,price,inv,cat||'General');
        }

        async function addProduct(name,desc,price,inv,cat){
            try{
                var fd=new FormData();
                fd.append('name',name);fd.append('description',desc);fd.append('price',price);fd.append('inventory',inv);fd.append('category',cat);
                var r=await fetch('/api/admin/shop/product/add',{method:'POST',headers:authHeaders(),body:fd});
                var d=await r.json();
                if(d.success){showToast('Product added: '+d.product_id,'success');loadProducts();}
                else{showToast(d.error||'Failed','error');}
            }catch(e){showToast('Error: '+e.message,'error');}
        }

        async function editProduct(id){
            var price=prompt('New price (leave empty to skip):');
            var inv=prompt('New inventory (leave empty to skip):');
            if(!price&&!inv)return;
            try{
                var fd=new FormData();
                fd.append('product_id',id);
                if(price)fd.append('price',price);
                if(inv)fd.append('inventory',inv);
                var r=await fetch('/api/admin/shop/product/update',{method:'PUT',headers:authHeaders(),body:fd});
                var d=await r.json();
                if(d.success){showToast('Product updated','success');loadProducts();}
                else{showToast(d.error||'Failed','error');}
            }catch(e){showToast('Error: '+e.message,'error');}
        }

        async function deleteProduct(id,name){
            if(!confirm('Delete product: '+name+'?'))return;
            try{
                var fd=new FormData();fd.append('product_id',id);
                var r=await fetch('/api/admin/shop/product/delete',{method:'DELETE',headers:authHeaders(),body:fd});
                var d=await r.json();
                if(d.success){showToast('Product deleted','success');loadProducts();}
                else{showToast(d.error||'Failed','error');}
            }catch(e){showToast('Error: '+e.message,'error');}
        }

        // Init
        window.addEventListener('load',function(){loadSystemStats();loadUsers();loadSessions();loadWalletStats();loadProducts();loadOrderStats();setInterval(loadSystemStats,10000)});
    </script>
<script src="/js/navbar.js"></script>
</body>
</html>
