<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32-SCADA | Mobile</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/scada.css">
  <link rel="stylesheet" href="/css/mobile.css">
  <style>
    body { padding: 16px; }
    .mobile-nav { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    .mobile-nav a { flex:1; min-width:80px; text-align:center; padding:12px; background:var(--bg-secondary);
      border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:0.85rem; }
    .mobile-nav a:hover { background:var(--bg-surface); text-decoration:none; }
  </style>
</head>
<body>
  <div style="text-align:center;margin-bottom:16px">
    <div class="sidebar-logo" style="font-size:1.2rem">ESP32-SCADA</div>
    <div class="text-xs text-muted">Mobile Operator View</div>
  </div>

  <div class="mobile-nav">
    <a href="/dashboard">Dashboard</a>
    <a href="/sensors">Sensors</a>
    <a href="/alarms">Alarms</a>
    <a href="/flags">Flags</a>
  </div>

  <!-- Quick Status -->
  <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px" id="quick-stats">
    <div class="card text-center"><div class="metric-value text-red" id="m-alarms">-</div><div class="metric-label">Alarms</div></div>
    <div class="card text-center"><div class="metric-value text-yellow" id="m-incidents">-</div><div class="metric-label">Incidents</div></div>
  </div>

  <!-- Line Status -->
  <div id="m-lines" class="mt-md">
    <div class="card"><p class="text-muted">Loading...</p></div>
  </div>

  <!-- Quick Actions -->
  <div class="card mt-md">
    <button class="btn btn-danger" style="width:100%" onclick="emergencyStop()">EMERGENCY STOP</button>
  </div>

  <div style="text-align:center;margin-top:16px">
    <button class="btn btn-sm mode-toggle">Light</button>
    <button class="btn btn-sm" onclick="API.logout()">Logout</button>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth-sync.js"></script>
  <script src="/js/mode.js"></script>
  <script src="/js/notifications.js"></script>
  <script>
    Auth.requireAuth();

    async function loadMobile() {
      try {
        const data = await API.get('/api/dashboard/status');
        document.getElementById('m-alarms').textContent = data.active_alarms || 0;
        document.getElementById('m-incidents').textContent = data.active_incidents || 0;
        document.getElementById('m-lines').innerHTML = (data.lines||[]).map(l => `
          <div class="card" style="margin-bottom:8px">
            <div class="flex-between">
              <strong>${l.name}</strong>
              <span class="badge badge-${l.status==='running'?'green':l.status==='alarm'?'red':'gray'}">${l.status}</span>
            </div>
            <div class="card-sensors mt-md">
              ${(l.sensors||[]).map(s => `
                <div class="sensor-mini" data-status="${s.status}">
                  <span>${s.type[0].toUpperCase()}</span>
                  <span>${s.value}${s.unit}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');
      } catch (e) { /* silent */ }
    }

    async function emergencyStop() {
      if (confirm('EMERGENCY STOP: Are you sure?')) {
        try {
          // This would need an API endpoint; for now trigger via actuator
          Notify.error('Emergency stop sent via Serial');
        } catch (e) {}
      }
    }

    loadMobile();
    setInterval(loadMobile, 5000);
  </script>
</body>
</html>
