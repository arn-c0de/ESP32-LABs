<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ESP32-H4CK-SCADA</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">
      <h1>⚡ SCADA Control</h1>
    </div>
    <div class="nav-menu">
      <a href="/dashboard" class="active">Dashboard</a>
      <a href="/sensors">Sensors</a>
      <a href="/actuators">Actuators</a>
      <a href="/alarms">Alarms</a>
      <span class="nav-user" id="nav-user"></span>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>Production Overview</h2>
      <div class="system-status" id="system-status">
        <span class="status-badge status-online">● ONLINE</span>
        <span id="uptime"></span>
      </div>
    </div>

    <!-- Production Lines Grid -->
    <div class="lines-grid" id="lines-grid">
      <!-- Lines will be populated by JavaScript -->
    </div>

    <!-- System Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Sensors</h3>
        <div class="stat-value" id="total-sensors">--</div>
      </div>
      <div class="stat-card">
        <h3>Active Actuators</h3>
        <div class="stat-value" id="active-actuators">--</div>
      </div>
      <div class="stat-card">
        <h3>Active Alarms</h3>
        <div class="stat-value alarm-count" id="alarm-count">--</div>
      </div>
      <div class="stat-card">
        <h3>System Load</h3>
        <div class="stat-value" id="system-load">--</div>
      </div>
    </div>
  </div>

  <script src="/js/auth-sync.js"></script>
  <script src="/js/navbar.js"></script>
  <script>
    requireAuth();
    
    let updateInterval;
    
    async function loadDashboard() {
      try {
        const token = localStorage.getItem('jwt_token');
        
        const response = await fetch('/api/dashboard/status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            logout();
            return;
          }
          throw new Error('Failed to load dashboard');
        }
        
        const data = await response.json();
        
        // Update system info
        document.getElementById('uptime').textContent = formatUptime(data.uptime);
        document.getElementById('total-sensors').textContent = data.total_sensors;
        document.getElementById('active-actuators').textContent = data.active_actuators;
        document.getElementById('alarm-count').textContent = data.active_alarms;
        document.getElementById('system-load').textContent = `${data.cpu_usage}%`;
        
        // Update production lines
        const linesGrid = document.getElementById('lines-grid');
        linesGrid.innerHTML = '';
        
        data.lines.forEach(line => {
          const lineCard = document.createElement('div');
          lineCard.className = `line-card line-status-${line.status}`;
          lineCard.innerHTML = `
            <div class="line-header">
              <h3>Production Line ${line.number}</h3>
              <span class="status-badge status-${line.status}">${line.status.toUpperCase()}</span>
            </div>
            <div class="line-metrics">
              <div class="metric">
                <span class="metric-label">Temperature:</span>
                <span class="metric-value">${line.temp.toFixed(1)}°C</span>
              </div>
              <div class="metric">
                <span class="metric-label">Pressure:</span>
                <span class="metric-value">${line.pressure.toFixed(1)} bar</span>
              </div>
              <div class="metric">
                <span class="metric-label">Flow:</span>
                <span class="metric-value">${line.flow.toFixed(1)} L/min</span>
              </div>
              <div class="metric">
                <span class="metric-label">Motor:</span>
                <span class="metric-value">${line.motor_state} (${line.motor_speed.toFixed(0)}%)</span>
              </div>
            </div>
            ${line.alarms > 0 ? `<div class="line-alarms">⚠️ ${line.alarms} alarm(s)</div>` : ''}
          `;
          linesGrid.appendChild(lineCard);
        });
        
      } catch (error) {
        console.error('Dashboard error:', error);
      }
    }
    
    function formatUptime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }
    
    // Initial load
    loadDashboard();
    
    // Auto-refresh every 3 seconds
    updateInterval = setInterval(loadDashboard, 3000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (updateInterval) clearInterval(updateInterval);
    });
  </script>
</body>
</html>
